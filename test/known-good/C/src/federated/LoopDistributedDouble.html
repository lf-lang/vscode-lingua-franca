<span class="source-lf comment-block-lflang">
/**
</span>

<span class="source-lf comment-block-lflang">
 * This tests a feedback loop with physical actions and centralized coordination.
</span>

<span class="source-lf comment-block-lflang">
 *
</span>

<span class="source-lf comment-block-lflang">
 * @author Edward A. Lee
</span>

<span class="source-lf comment-block-lflang">
 
</span>
<span class="source-lf comment-block-lflang">
*/
</span>

<span class="source-lf meta-targetspec-lflang keyword-control-lflang">
target
</span>
<span class="source-lf meta-targetspec-lflang">
 
</span>
<span class="source-lf meta-targetspec-lflang constant-language-lflang">
C
</span>
<span class="source-lf meta-targetspec-lflang">
 {
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  flags
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang string-quoted-double-lflang">
"
</span>
<span class="source-lf meta-targetspec-lflang string-quoted-double-lflang">
-Wall
</span>
<span class="source-lf meta-targetspec-lflang string-quoted-double-lflang">
"
</span>
<span class="source-lf meta-targetspec-lflang">
,
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  coordination
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang storage-type-lflang">
centralized
</span>
<span class="source-lf meta-targetspec-lflang">
,
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  coordination-options
</span>
<span class="source-lf meta-targetspec-lflang">
: {
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
    advance-message-interval
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-int-lflang">
100
</span>
<span class="source-lf meta-targetspec-lflang">
 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-lflang">
msec
</span>

<span class="source-lf meta-targetspec-lflang">
  },
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  timeout
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-int-lflang">
5
</span>
<span class="source-lf meta-targetspec-lflang">
 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-lflang">
sec
</span>

<span class="source-lf meta-targetspec-lflang">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf keyword-control-lflang">
preamble
</span>
<span class="source-lf">
 {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>

<span class="source-lf comment-line-double-dash-lflang">
  
</span>
<span class="source-lf comment-line-double-dash-lflang">
#include <unistd.h> // Defines sleep()
</span>

<span class="source-lf">
  extern bool stop;
</span>

<span class="source-lf">
  void
</span>
<span class="source-lf keyword-operator-lflang">
*
</span>
<span class="source-lf">
 ping(void
</span>
<span class="source-lf keyword-operator-lflang">
*
</span>
<span class="source-lf">
 action
</span>
<span class="source-lf">
ref)
</span>
<span class="source-lf">
;
</span>

<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf storage-modifier-lflang">
reactor
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
Looper
</span>
<span class="source-lf">
(incr: 
</span>
<span class="source-lf storage-type-lflang">
int
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf constant-numeric-int-lflang">
1
</span>
<span class="source-lf">
, delay: 
</span>
<span class="source-lf storage-type-lflang">
time
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf constant-numeric-int-lflang">
0
</span>
<span class="source-lf">
 
</span>
<span class="source-lf constant-numeric-lflang">
msec
</span>
<span class="source-lf">
) {
</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
preamble
</span>
<span class="source-lf">
 {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>

<span class="source-lf">
    bool stop 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf constant-language-lflang">
false
</span>
<span class="source-lf">
;
</span>

<span class="source-lf comment-line-double-dash-lflang">
    
</span>
<span class="source-lf comment-line-double-dash-lflang">
// Thread to trigger an action once every second.
</span>

<span class="source-lf">
    void
</span>
<span class="source-lf keyword-operator-lflang">
*
</span>
<span class="source-lf">
 ping(void
</span>
<span class="source-lf keyword-operator-lflang">
*
</span>
<span class="source-lf">
 action
</span>
<span class="source-lf">
ref) {
</span>

<span class="source-lf">
      while(!stop) {
</span>

<span class="source-lf">
        lf_print(
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
Scheduling action.
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
);
</span>

<span class="source-lf">
        lf_schedule(action
</span>
<span class="source-lf">
ref, 0)
</span>
<span class="source-lf">
;
</span>

<span class="source-lf">
        sleep(
</span>
<span class="source-lf constant-numeric-int-lflang">
1
</span>
<span class="source-lf">
);
</span>

<span class="source-lf">
      }
</span>

<span class="source-lf">
      return NULL;
</span>

<span class="source-lf">
    }
</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
input
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
in
</span>
<span class="source-lf">
:
</span>
<span class="source-lf meta-embedded-block-cpp">
 
</span>
<span class="source-lf meta-embedded-block-cpp storage-type-lflang">
int
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
input
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
in2
</span>
<span class="source-lf">
:
</span>
<span class="source-lf meta-embedded-block-cpp">
 
</span>
<span class="source-lf meta-embedded-block-cpp storage-type-lflang">
int
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
output
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
out
</span>
<span class="source-lf">
:
</span>
<span class="source-lf meta-embedded-block-cpp">
 
</span>
<span class="source-lf meta-embedded-block-cpp storage-type-lflang">
int
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
output
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
out2
</span>
<span class="source-lf">
:
</span>
<span class="source-lf meta-embedded-block-cpp">
 
</span>
<span class="source-lf meta-embedded-block-cpp storage-type-lflang">
int
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
physical
</span>
<span class="source-lf">
 
</span>
<span class="source-lf storage-modifier-lflang">
action
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
a
</span>
<span class="source-lf">
(
</span>
<span class="source-lf">
delay)
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
state
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
count
</span>
<span class="source-lf">
:
</span>
<span class="source-lf meta-embedded-block-cpp">
 
</span>
<span class="source-lf meta-embedded-block-cpp storage-type-lflang">
int
</span>
<span class="source-lf meta-embedded-block-cpp">
 
</span>
<span class="source-lf">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf constant-numeric-int-lflang">
0
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
timer
</span>
<span class="source-lf">
 t(
</span>
<span class="source-lf constant-numeric-int-lflang">
0
</span>
<span class="source-lf">
, 
</span>
<span class="source-lf constant-numeric-int-lflang">
1
</span>
<span class="source-lf">
 
</span>
<span class="source-lf constant-numeric-lflang">
sec
</span>
<span class="source-lf">
)
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(
</span>
<span class="source-lf support-variable-lflang">
startup
</span>
<span class="source-lf">
) 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 a {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>

<span class="source-lf comment-line-double-dash-lflang">
    
</span>
<span class="source-lf comment-line-double-dash-lflang">
// Start the thread that listens for Enter or Return.
</span>

<span class="source-lf">
    lf_thread_t thread_id;
</span>

<span class="source-lf">
    lf_print(
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
Starting thread.
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
);
</span>

<span class="source-lf">
    lf_thread_create(&thread_id, &ping, a);
</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(
</span>
<span class="source-lf">
a) 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 out, out2 {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>

<span class="source-lf">
    if (self
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
count
</span>
<span class="source-lf keyword-operator-lflang">
%
</span>
<span class="source-lf constant-numeric-int-lflang">
2
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf constant-numeric-int-lflang">
0
</span>
<span class="source-lf">
) {
</span>

<span class="source-lf">
      lf_set(out, self
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
count);
</span>

<span class="source-lf">
    } else {
</span>

<span class="source-lf">
      lf_set(out2, self
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
count);
</span>

<span class="source-lf">
    }
</span>

<span class="source-lf">
    self
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
count 
</span>
<span class="source-lf keyword-operator-lflang">
+
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 self
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
incr;
</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(
</span>
<span class="source-lf">
in) {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>

<span class="source-lf">
    tag_t current_tag 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 lf_tag();
</span>

<span class="source-lf">
    lf_print(
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
Received %d at logical time (%lld, %d).
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
,
</span>

<span class="source-lf">
      in
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
value,
</span>

<span class="source-lf">
      
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
current_tag
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf storage-type-lflang">
time
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
-
</span>
<span class="source-lf">
 lf_time_start(), 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
current_tag
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
microstep
</span>

<span class="source-lf">
    );
</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(
</span>
<span class="source-lf">
in2) {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>

<span class="source-lf">
    tag_t current_tag 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 lf_tag();
</span>

<span class="source-lf">
    lf_print(
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
Received %d on in2 at logical time (%lld, %d).
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
,
</span>

<span class="source-lf">
      in2
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
value,
</span>

<span class="source-lf">
      
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
current_tag
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf storage-type-lflang">
time
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
-
</span>
<span class="source-lf">
 lf_time_start(), 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
current_tag
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
microstep
</span>

<span class="source-lf">
    );
</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(
</span>
<span class="source-lf">
t) {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>

<span class="source-lf">
    tag_t current_tag 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 lf_tag();
</span>

<span class="source-lf">
    lf_print(
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
Timer triggered at logical time (%lld, %d).
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
,
</span>

<span class="source-lf">
      
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
current_tag
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf storage-type-lflang">
time
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
-
</span>
<span class="source-lf">
 lf_time_start(), 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
current_tag
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
microstep
</span>

<span class="source-lf">
    );
</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(
</span>
<span class="source-lf support-variable-lflang">
shutdown
</span>
<span class="source-lf">
) {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>

<span class="source-lf">
    lf_print(
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
******* Shutdown invoked.
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
);
</span>

<span class="source-lf comment-line-double-dash-lflang">
    
</span>
<span class="source-lf comment-line-double-dash-lflang">
// Stop the thread that is scheduling actions.
</span>

<span class="source-lf">
    stop 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf constant-language-lflang">
true
</span>
<span class="source-lf">
;
</span>

<span class="source-lf">
    if (self
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
count !
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf constant-numeric-int-lflang">
5
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
*
</span>
<span class="source-lf">
 self
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
incr) {
</span>

<span class="source-lf">
      lf_print_error_and_exit(
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
Failed to receive all five expected inputs.
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
);
</span>

<span class="source-lf">
    }
</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf storage-modifier-lflang">
federated
</span>
<span class="source-lf">
 
</span>
<span class="source-lf storage-modifier-lflang">
reactor
</span>
<span class="source-lf">
(delay: 
</span>
<span class="source-lf storage-type-lflang">
time
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf constant-numeric-int-lflang">
0
</span>
<span class="source-lf">
) {
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
left
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-control-new-lflang">
new
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
Looper
</span>
<span class="source-lf">
()
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
right
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-control-new-lflang">
new
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
Looper
</span>
<span class="source-lf">
(incr
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf keyword-operator-lflang">
-
</span>
<span class="source-lf constant-numeric-int-lflang">
1
</span>
<span class="source-lf">
)
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
left
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
out
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
right
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
in
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
right
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
out
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
left
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
in
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
right
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
out2
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
left
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
in2
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
left
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
out2
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
right
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
in2
</span>

<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

