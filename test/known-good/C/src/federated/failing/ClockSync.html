<span class="source-lf comment-block-lflang">
/**
</span>

<span class="source-lf comment-block-lflang">
 * This program tests clock synchronization. It checks the clock synchronization error and fails if
</span>

<span class="source-lf comment-block-lflang">
 * it exceeds a threshold. Note that failures could occur here intermittently because clock
</span>

<span class="source-lf comment-block-lflang">
 * synchronization accuracy depends on many conditions. But the threshold is quite high, so failures
</span>

<span class="source-lf comment-block-lflang">
 * should be rare.
</span>

<span class="source-lf comment-block-lflang">
 * @author Edward A. Lee
</span>

<span class="source-lf comment-block-lflang">
 
</span>
<span class="source-lf comment-block-lflang">
*/
</span>

<span class="source-lf meta-targetspec-lflang keyword-control-lflang">
target
</span>
<span class="source-lf meta-targetspec-lflang">
 
</span>
<span class="source-lf meta-targetspec-lflang constant-language-lflang">
C
</span>
<span class="source-lf meta-targetspec-lflang">
 {
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  coordination
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang storage-type-lflang">
decentralized
</span>
<span class="source-lf meta-targetspec-lflang">
,
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  timeout
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-int-lflang">
10
</span>
<span class="source-lf meta-targetspec-lflang">
 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-lflang">
sec
</span>
<span class="source-lf meta-targetspec-lflang">
,
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  clock-sync
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang storage-type-lflang">
on
</span>
<span class="source-lf meta-targetspec-lflang">
,  
</span>
<span class="source-lf meta-targetspec-lflang comment-line-double-dash-lflang">
// Turn on runtime clock synchronization.
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  clock-sync-options
</span>
<span class="source-lf meta-targetspec-lflang">
: {
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  local-federates-on
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang constant-language-lflang">
true
</span>
<span class="source-lf meta-targetspec-lflang">
,  
</span>
<span class="source-lf meta-targetspec-lflang comment-line-double-dash-lflang">
// Forces all federates to perform clock sync.
</span>

<span class="source-lf meta-targetspec-lflang comment-line-double-dash-lflang">
  
</span>
<span class="source-lf meta-targetspec-lflang comment-line-double-dash-lflang">
// Collect useful statistics like average network delay and the standard deviation for the
</span>

<span class="source-lf meta-targetspec-lflang comment-line-double-dash-lflang">
  
</span>
<span class="source-lf meta-targetspec-lflang comment-line-double-dash-lflang">
// network delay over one clock synchronization cycle. Generates a warning if the standard
</span>

<span class="source-lf meta-targetspec-lflang comment-line-double-dash-lflang">
  
</span>
<span class="source-lf meta-targetspec-lflang comment-line-double-dash-lflang">
// deviation is higher than the clock sync guard. Artificially offsets clocks by multiples of
</span>

<span class="source-lf meta-targetspec-lflang comment-line-double-dash-lflang">
  
</span>
<span class="source-lf meta-targetspec-lflang comment-line-double-dash-lflang">
// 200 msec.
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  collect-stats
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang constant-language-lflang">
true
</span>
<span class="source-lf meta-targetspec-lflang">
,
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  test-offset
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-int-lflang">
200
</span>
<span class="source-lf meta-targetspec-lflang">
 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-lflang">
msec
</span>
<span class="source-lf meta-targetspec-lflang">
,
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  period
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-int-lflang">
5
</span>
<span class="source-lf meta-targetspec-lflang">
 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-lflang">
msec
</span>
<span class="source-lf meta-targetspec-lflang">
,  
</span>
<span class="source-lf meta-targetspec-lflang comment-line-double-dash-lflang">
// Period with which runtime clock sync is performed.
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  trials
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-int-lflang">
10
</span>
<span class="source-lf meta-targetspec-lflang">
,  
</span>
<span class="source-lf meta-targetspec-lflang comment-line-double-dash-lflang">
// Number of messages exchanged to perform clock sync.
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  attenuation
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-int-lflang">
10
</span>
<span class="source-lf meta-targetspec-lflang">
  
</span>
<span class="source-lf meta-targetspec-lflang comment-line-double-dash-lflang">
// Attenuation applied to runtime clock sync adjustments.
</span>

<span class="source-lf meta-targetspec-lflang">
  }
</span>

<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf comment-block-lflang">
/**
</span>
<span class="source-lf comment-block-lflang">
 Reactor that outputs periodically. 
</span>
<span class="source-lf comment-block-lflang">
*/
</span>

<span class="source-lf storage-modifier-lflang">
reactor
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
Ticker
</span>
<span class="source-lf">
(period: 
</span>
<span class="source-lf storage-type-lflang">
time
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf constant-numeric-int-lflang">
1600
</span>
<span class="source-lf">
 
</span>
<span class="source-lf constant-numeric-lflang">
msec
</span>
<span class="source-lf">
) {
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
output
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
out
</span>
<span class="source-lf">
:
</span>
<span class="source-lf meta-embedded-block-cpp">
 
</span>
<span class="source-lf meta-embedded-block-cpp storage-type-lflang">
int
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
timer
</span>
<span class="source-lf">
 tick(
</span>
<span class="source-lf constant-numeric-int-lflang">
0
</span>
<span class="source-lf">
, period)
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(
</span>
<span class="source-lf">
tick) 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 out {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 lf_set(out, 
</span>
<span class="source-lf constant-numeric-int-lflang">
42
</span>
<span class="source-lf">
); 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf comment-block-lflang">
/**
</span>
<span class="source-lf comment-block-lflang">
 Print a message when an input arrives. 
</span>
<span class="source-lf comment-block-lflang">
*/
</span>

<span class="source-lf storage-modifier-lflang">
reactor
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
Printer
</span>
<span class="source-lf">
 {
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
input
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
in
</span>
<span class="source-lf">
:
</span>
<span class="source-lf meta-embedded-block-cpp">
 
</span>
<span class="source-lf meta-embedded-block-cpp storage-type-lflang">
int
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(
</span>
<span class="source-lf support-variable-lflang">
startup
</span>
<span class="source-lf">
) {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>

<span class="source-lf">
  interval_t offset 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 _lf_time_physical_clock_offset 
</span>
<span class="source-lf keyword-operator-lflang">
+
</span>
<span class="source-lf">
 _lf_time_test_physical_clock_offset;
</span>

<span class="source-lf">
  lf_print(
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
Clock sync error at startup is %lld ns.
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
, offset);
</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(
</span>
<span class="source-lf">
in) {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 lf_print(
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
Received %d.
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
, in
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
value); 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(
</span>
<span class="source-lf support-variable-lflang">
shutdown
</span>
<span class="source-lf">
) {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>

<span class="source-lf">
  interval_t offset 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 _lf_time_physical_clock_offset 
</span>
<span class="source-lf keyword-operator-lflang">
+
</span>
<span class="source-lf">
 _lf_time_test_physical_clock_offset;
</span>

<span class="source-lf">
  lf_print(
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
Clock sync error at shutdown is %lld ns.
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
, offset);
</span>

<span class="source-lf comment-line-double-dash-lflang">
  
</span>
<span class="source-lf comment-line-double-dash-lflang">
// Error out if the offset is bigger than 100 msec.
</span>

<span class="source-lf">
  if (offset > MSEC(
</span>
<span class="source-lf constant-numeric-int-lflang">
100
</span>
<span class="source-lf">
)) {
</span>

<span class="source-lf">
    lf_print_error(
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
Offset exceeds test threshold of 100 msec.
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
);
</span>

<span class="source-lf">
    exit(
</span>
<span class="source-lf constant-numeric-int-lflang">
1
</span>
<span class="source-lf">
);
</span>

<span class="source-lf">
  }
</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf storage-modifier-lflang">
reactor
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
Federate
</span>
<span class="source-lf">
 {
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
source
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-control-new-lflang">
new
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
Ticker
</span>
<span class="source-lf">
()
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
play
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-control-new-lflang">
new
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
Printer
</span>
<span class="source-lf">
()
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
source
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
out
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
play
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
in
</span>

<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf storage-modifier-lflang">
federated
</span>
<span class="source-lf">
 
</span>
<span class="source-lf storage-modifier-lflang">
reactor
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
ClockSync
</span>
<span class="source-lf">
 {
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
fed1
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-control-new-lflang">
new
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
Federate
</span>
<span class="source-lf">
()
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
fed2
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-control-new-lflang">
new
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
Federate
</span>
<span class="source-lf">
()
</span>

<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

