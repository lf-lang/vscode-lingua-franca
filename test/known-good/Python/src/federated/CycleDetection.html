<span class="source-lf comment-block-lflang">
/**
</span>

<span class="source-lf comment-block-lflang">
 * Check whether the internally generated network and control reactions introduce a cycle or not.
</span>

<span class="source-lf comment-block-lflang">
 * The failure for this test is not being compiled.
</span>

<span class="source-lf comment-block-lflang">
 * @author Edward A. Lee
</span>

<span class="source-lf comment-block-lflang">
 
</span>
<span class="source-lf comment-block-lflang">
*/
</span>

<span class="source-lf meta-targetspec-lflang keyword-control-lflang">
target
</span>
<span class="source-lf meta-targetspec-lflang">
 
</span>
<span class="source-lf meta-targetspec-lflang constant-language-lflang">
Python
</span>

<span class="source-lf">

</span>

<span class="source-lf storage-modifier-lflang">
reactor
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
CAReplica
</span>
<span class="source-lf">
 {
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
input
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
local_update
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
input
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
remote_update
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
input
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
query
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
state
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
balance
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf constant-numeric-int-lflang">
0
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
output
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
response
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(local_update, remote_update) 
</span>
<span class="source-lf meta-embedded-block-py">
{=
</span>

<span class="source-lf meta-embedded-block-py">
    if local_update.is_present:
</span>

<span class="source-lf meta-embedded-block-py">
      self.balance += local_update.value
</span>

<span class="source-lf meta-embedded-block-py">
    if remote_update.is_present:
</span>

<span class="source-lf meta-embedded-block-py">
      self.balance += remote_update.value
</span>

<span class="source-lf meta-embedded-block-py">
  
</span>
<span class="source-lf meta-embedded-block-py">
=}
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(query) 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 response 
</span>
<span class="source-lf meta-embedded-block-py">
{=
</span>

<span class="source-lf meta-embedded-block-py">
    response.set(self.balance)
</span>

<span class="source-lf meta-embedded-block-py">
  
</span>
<span class="source-lf meta-embedded-block-py">
=}
</span>

<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf storage-modifier-lflang">
reactor
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
UserInput
</span>
<span class="source-lf">
 {
</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
preamble
</span>
<span class="source-lf">
 
</span>
<span class="source-lf meta-embedded-block-py">
{=
</span>

<span class="source-lf meta-embedded-block-py">
    
</span>
<span class="source-lf meta-embedded-block-py keyword-control-import-python">
import
</span>
<span class="source-lf meta-embedded-block-py">
 sys
</span>

<span class="source-lf meta-embedded-block-py">
  
</span>
<span class="source-lf meta-embedded-block-py">
=}
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
input
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
balance
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
output
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
deposit
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(
</span>
<span class="source-lf support-variable-lflang">
startup
</span>
<span class="source-lf">
) 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 deposit 
</span>
<span class="source-lf meta-embedded-block-py">
{=
</span>

<span class="source-lf meta-embedded-block-py">
    deposit.set(100)
</span>

<span class="source-lf meta-embedded-block-py">
  
</span>
<span class="source-lf meta-embedded-block-py">
=}
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(balance) 
</span>
<span class="source-lf meta-embedded-block-py">
{=
</span>

<span class="source-lf meta-embedded-block-py">
    if balance.value != 200:
</span>

<span class="source-lf meta-embedded-block-py">
      self.sys.stderr.write("Did not receive the expected balance. Expected: 200. Got: {}.\n".format(balance.value))
</span>

<span class="source-lf meta-embedded-block-py">
      self.sys.exit(1)
</span>

<span class="source-lf meta-embedded-block-py">
    print("Balance: {}".format(balance.value))
</span>

<span class="source-lf meta-embedded-block-py">
    request_stop()
</span>

<span class="source-lf meta-embedded-block-py">
  
</span>
<span class="source-lf meta-embedded-block-py">
=}
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(
</span>
<span class="source-lf support-variable-lflang">
shutdown
</span>
<span class="source-lf">
) 
</span>
<span class="source-lf meta-embedded-block-py">
{=
</span>

<span class="source-lf meta-embedded-block-py">
    print("Test passed!")
</span>

<span class="source-lf meta-embedded-block-py">
  
</span>
<span class="source-lf meta-embedded-block-py">
=}
</span>

<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf storage-modifier-lflang">
federated
</span>
<span class="source-lf">
 
</span>
<span class="source-lf storage-modifier-lflang">
reactor
</span>
<span class="source-lf">
 {
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
u1
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-control-new-lflang">
new
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
UserInput
</span>
<span class="source-lf">
()
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
r1
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-control-new-lflang">
new
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
CAReplica
</span>
<span class="source-lf">
()
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
u2
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-control-new-lflang">
new
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
UserInput
</span>
<span class="source-lf">
()
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
r2
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-control-new-lflang">
new
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
CAReplica
</span>
<span class="source-lf">
()
</span>

<span class="source-lf">
  (
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
u1
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
deposit
</span>
<span class="source-lf">
)
</span>
<span class="source-lf keyword-operator-lflang">
+
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
r1
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
query
</span>
<span class="source-lf">
, 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
r1
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
local_update
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
r1
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
response
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
u1
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
balance
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
u1
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
deposit
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
r2
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
remote_update
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  (
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
u2
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
deposit
</span>
<span class="source-lf">
)
</span>
<span class="source-lf keyword-operator-lflang">
+
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
r2
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
query
</span>
<span class="source-lf">
, 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
r2
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
local_update
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
r2
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
response
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
u2
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
balance
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
u2
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
deposit
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
r1
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
remote_update
</span>

<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

