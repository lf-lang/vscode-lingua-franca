<span class="source-lf comment-block-lflang">
/**
</span>

<span class="source-lf comment-block-lflang">
 * Test the case for when two upstream federates send messages to a downstream federte on two
</span>

<span class="source-lf comment-block-lflang">
 * different ports. One message should carry a microstep delay relative to the other message.
</span>

<span class="source-lf comment-block-lflang">
 *
</span>

<span class="source-lf comment-block-lflang">
 * @author Soroush Bateni
</span>

<span class="source-lf comment-block-lflang">
 * @author Hokeun Kim
</span>

<span class="source-lf comment-block-lflang">
 
</span>
<span class="source-lf comment-block-lflang">
*/
</span>

<span class="source-lf meta-targetspec-lflang keyword-control-lflang">
target
</span>
<span class="source-lf meta-targetspec-lflang">
 
</span>
<span class="source-lf meta-targetspec-lflang constant-language-lflang">
TypeScript
</span>
<span class="source-lf meta-targetspec-lflang">
 {
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  timeout
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-int-lflang">
900
</span>
<span class="source-lf meta-targetspec-lflang">
 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-lflang">
msec
</span>
<span class="source-lf meta-targetspec-lflang">
,
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  coordination-options
</span>
<span class="source-lf meta-targetspec-lflang">
: {
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
    advance-message-interval
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-int-lflang">
100
</span>
<span class="source-lf meta-targetspec-lflang">
 
</span>
<span class="source-lf meta-targetspec-lflang constant-numeric-lflang">
msec
</span>

<span class="source-lf meta-targetspec-lflang">
  },
</span>

<span class="source-lf meta-targetspec-lflang variable-parameter-lflang">
  logging
</span>
<span class="source-lf meta-targetspec-lflang">
: 
</span>
<span class="source-lf meta-targetspec-lflang storage-type-lflang">
DEBUG
</span>

<span class="source-lf meta-targetspec-lflang">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf keyword-control-import-lflang">
import
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
Count
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-control-import-lflang">
from
</span>
<span class="source-lf">
 
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
../lib/Count.lf
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>

<span class="source-lf">

</span>

<span class="source-lf storage-modifier-lflang">
reactor
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
CountMicrostep
</span>
<span class="source-lf">
 {
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
state
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
count
</span>
<span class="source-lf">
:
</span>
<span class="source-lf">
 
</span>
<span class="source-lf storage-type-lflang">
number
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf constant-numeric-int-lflang">
1
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
output
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
out
</span>
<span class="source-lf">
:
</span>
<span class="source-lf">
 
</span>
<span class="source-lf storage-type-lflang">
number
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
logical
</span>
<span class="source-lf">
 
</span>
<span class="source-lf storage-modifier-lflang">
action
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
act
</span>
<span class="source-lf">
:
</span>
<span class="source-lf">
 
</span>
<span class="source-lf storage-type-lflang">
number
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
timer
</span>
<span class="source-lf">
 t(
</span>
<span class="source-lf constant-numeric-int-lflang">
0
</span>
<span class="source-lf">
, 
</span>
<span class="source-lf constant-numeric-int-lflang">
1
</span>
<span class="source-lf">
 
</span>
<span class="source-lf constant-numeric-lflang">
sec
</span>
<span class="source-lf">
)
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(t) 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 act {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
actions
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
act
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
schedule
</span>
<span class="source-lf">
(
</span>
<span class="source-lf constant-numeric-int-lflang">
0
</span>
<span class="source-lf">
, count
</span>
<span class="source-lf keyword-operator-lflang">
+
</span>
<span class="source-lf keyword-operator-lflang">
+
</span>
<span class="source-lf">
); 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(act) 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 out {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 out 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 act; 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf storage-modifier-lflang">
reactor
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
Print
</span>
<span class="source-lf">
 {
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
input
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
inp
</span>
<span class="source-lf">
:
</span>
<span class="source-lf">
 
</span>
<span class="source-lf storage-type-lflang">
number
</span>

<span class="source-lf">
  
</span>
<span class="source-lf storage-modifier-lflang">
input
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-lflang">
inp2
</span>
<span class="source-lf">
:
</span>
<span class="source-lf">
 
</span>
<span class="source-lf storage-type-lflang">
number
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(inp, inp2) {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>

<span class="source-lf">
    
</span>
<span class="source-lf storage-modifier-lflang">
const
</span>
<span class="source-lf">
 elapsedTime 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
util
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
getElapsedLogicalTime
</span>
<span class="source-lf">
();
</span>

<span class="source-lf">
    
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
console
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
log
</span>
<span class="source-lf">
(
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
At tag 
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
+
</span>
<span class="source-lf">
 elapsedTime 
</span>
<span class="source-lf keyword-operator-lflang">
+
</span>
<span class="source-lf">
 
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
, microstep:
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
+
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
util
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
getCurrentTag
</span>
<span class="source-lf">
()
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf">
microstep 
</span>
<span class="source-lf keyword-operator-lflang">
+
</span>

<span class="source-lf">
      
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
, received inp = 
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
+
</span>
<span class="source-lf">
 inp 
</span>
<span class="source-lf keyword-operator-lflang">
+
</span>
<span class="source-lf">
 
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
 and inp2 = 
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
+
</span>
<span class="source-lf">
 inp2 
</span>
<span class="source-lf keyword-operator-lflang">
+
</span>
<span class="source-lf">
 
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
.
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
);
</span>

<span class="source-lf">
    if (inp !
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 undefined && inp2 !
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 undefined) {
</span>

<span class="source-lf">
      
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
util
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
requestErrorStop
</span>
<span class="source-lf">
(
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
ERROR: invalid logical simultaneity.
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
);
</span>

<span class="source-lf">
    }
</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf">
  
</span>
<span class="source-lf keyword-control-lflang">
reaction
</span>
<span class="source-lf">
(
</span>
<span class="source-lf support-variable-lflang">
shutdown
</span>
<span class="source-lf">
) {
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
console
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
log
</span>
<span class="source-lf">
(
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf string-quoted-double-lflang">
SUCCESS: messages were at least one microstep apart.
</span>
<span class="source-lf string-quoted-double-lflang">
"
</span>
<span class="source-lf">
); 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
}
</span>

<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

<span class="source-lf storage-modifier-lflang">
federated
</span>
<span class="source-lf">
 
</span>
<span class="source-lf storage-modifier-lflang">
reactor
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
DistributedDoublePort
</span>
<span class="source-lf">
 {
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
c
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-control-new-lflang">
new
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
Count
</span>
<span class="source-lf">
()
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
cm
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-control-new-lflang">
new
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
CountMicrostep
</span>
<span class="source-lf">
()
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
p
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
=
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-control-new-lflang">
new
</span>
<span class="source-lf">
 
</span>
<span class="source-lf entity-name-type-lflang">
Print
</span>
<span class="source-lf">
()
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
c
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
out
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
p
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
inp
</span>
<span class="source-lf">
  
</span>
<span class="source-lf comment-line-double-dash-lflang">
// Indicating a 'logical' connection.
</span>

<span class="source-lf">
  
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
cm
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
out
</span>
<span class="source-lf">
 
</span>
<span class="source-lf keyword-operator-lflang">
->
</span>
<span class="source-lf">
 
</span>
<span class="source-lf variable-other-constant-reactorinstance-lflang">
p
</span>
<span class="source-lf keyword-operator-lflang">
.
</span>
<span class="source-lf variable-other-lflang">
inp2
</span>

<span class="source-lf">
}
</span>

<span class="source-lf">

</span>

